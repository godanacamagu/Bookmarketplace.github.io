<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Campus Books - Student Marketplace</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #59e24a;
            --secondary-color: #f39c12;
            --dark-color: #2c3e50;
            --light-bg: #f8f9fa;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--light-bg);
        }

        .navbar {
            background: linear-gradient(135deg, var(--primary-color), #357abd);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .navbar-brand {
            font-weight: bold;
            font-size: 1.5rem;
        }

        .hero-section {
            background: linear-gradient(135deg, var(--primary-color), #357abd);
            color: white;
            padding: 60px 0;
            margin-bottom: 40px;
        }

        .book-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s, box-shadow 0.3s;
            margin-bottom: 30px;
            overflow: hidden;
            position: relative;
        }

        .book-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
        }

        .book-image {
            width: 100%;
            height: 250px;
            object-fit: cover;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 3rem;
            position: relative;
        }

        .book-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .book-image .default-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .image-preview-container {
            position: relative;
            width: 100%;
            max-width: 300px;
            margin: 0 auto;
        }

        .image-preview {
            width: 100%;
            height: 200px;
            border: 2px dashed #ddd;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            background: #f8f9fa;
        }

        .image-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-preview-placeholder {
            text-align: center;
            color: #999;
        }

        .remove-image-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 10;
        }

        .price-tag {
            background: var(--secondary-color);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 1.2rem;
        }

        .btn-primary {
            background: var(--primary-color);
            border: none;
            padding: 10px 30px;
            border-radius: 25px;
            transition: all 0.3s;
        }

        .btn-primary:hover {
            background: #357abd;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(74, 144, 226, 0.4);
        }

        .btn-success {
            border-radius: 25px;
            padding: 10px 30px;
        }

        .modal-content {
            border-radius: 15px;
        }

        .modal-header {
            background: linear-gradient(135deg, var(--primary-color), #357abd);
            color: white;
            border-radius: 15px 15px 0 0;
        }

        .search-box {
            max-width: 600px;
            margin: 0 auto 30px;
        }

        .filter-section {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }

        .badge-condition {
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.85rem;
        }

        .condition-new {
            background: #27ae60;
        }

        .condition-excellent {
            background: #3498db;
        }

        .condition-good {
            background: #f39c12;
        }

        .condition-fair {
            background: #e67e22;
        }

        .seller-info {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #eee;
        }

        .seller-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .message-badge {
            position: relative;
        }

        .message-badge .badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #dc3545;
            border-radius: 50%;
            padding: 4px 7px;
            font-size: 0.7rem;
        }

        .conversation-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .conversation-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.2s;
        }

        .conversation-item:hover {
            background: #f8f9fa;
        }

        .conversation-item.active {
            background: #e3f2fd;
            border-left: 3px solid var(--primary-color);
        }

        .conversation-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.2rem;
        }

        .unread-indicator {
            width: 10px;
            height: 10px;
            background: #dc3545;
            border-radius: 50%;
            display: inline-block;
        }

        .messages-container {
            height: 400px;
            overflow-y: auto;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
        }

        .message-bubble {
            max-width: 70%;
            margin-bottom: 15px;
            padding: 10px 15px;
            border-radius: 18px;
            word-wrap: break-word;
        }

        .message-sent {
            background: var(--primary-color);
            color: white;
            margin-left: auto;
            text-align: right;
        }

        .message-received {
            background: white;
            color: #333;
            margin-right: auto;
        }

        .message-time {
            font-size: 0.75rem;
            opacity: 0.7;
            margin-top: 5px;
        }

        .no-messages {
            text-align: center;
            padding: 50px 20px;
            color: #999;
        }

        .favorite-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 10;
            background: rgba(255, 255, 255, 0.9);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .favorite-btn:hover {
            transform: scale(1.1);
            background: white;
        }

        .favorite-btn i {
            font-size: 1.2rem;
        }

        .favorite-btn.favorited i {
            color: #dc3545;
        }

        .favorite-btn:not(.favorited) i {
            color: #999;
        }

        .wishlist-empty {
            text-align: center;
            padding: 80px 20px;
        }

        .wishlist-empty i {
            font-size: 4rem;
            color: #ddd;
            margin-bottom: 20px;
        }

        .advanced-search-section {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .search-category-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s;
        }

        .search-category-card:hover {
            border-color: var(--primary-color);
            box-shadow: 0 4px 12px rgba(74, 144, 226, 0.2);
        }

        .search-category-card h5 {
            color: var(--primary-color);
            margin-bottom: 15px;
        }

        .price-range-display {
            text-align: center;
            font-weight: bold;
            color: var(--primary-color);
            margin-top: 10px;
        }

        .quick-filter-btn {
            margin: 5px;
            border-radius: 20px;
        }

        .saved-search-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .search-stats {
            background: linear-gradient(135deg, var(--primary-color), #357abd);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="#"><i class="fas fa-book-open"></i> Campus Books</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item" id="navSellBook" style="display: none;">
                        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#sellBookModal">
                            <i class="fas fa-plus"></i> Sell a Book
                        </button>
                    </li>
                    <li class="nav-item" id="navLogin">
                        <button class="btn btn-outline-light me-2" data-bs-toggle="modal" data-bs-target="#loginModal">
                            <i class="fas fa-sign-in-alt"></i> Login
                        </button>
                    </li>
                    <li class="nav-item" id="navRegister">
                        <button class="btn btn-light" data-bs-toggle="modal" data-bs-target="#registerModal">
                            <i class="fas fa-user-plus"></i> Register
                        </button>
                    </li>
                    <li class="nav-item dropdown" id="navUserMenu" style="display: none;">
                        <a class="nav-link dropdown-toggle text-white" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user-circle"></i> <span id="currentUserName"></span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="#" id="addListingBtn"><i class="fas fa-plus-circle"></i>
                                    Add New Listing</a></li>
                            <li><a class="dropdown-item" href="#" id="myListingsBtn"><i class="fas fa-list"></i> My
                                    Listings</a></li>
                            <li><a class="dropdown-item" href="#" id="wishlistBtn"><i class="fas fa-heart"></i> My
                                    Wishlist <span class="badge bg-danger ms-1" id="wishlistCount"
                                        style="display: none;">0</span></a></li>
                            <li><a class="dropdown-item message-badge" href="#" id="messagesBtn">
                                    <i class="fas fa-envelope"></i> Messages
                                    <span class="badge" id="unreadCount" style="display: none;">0</span>
                                </a></li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li><a class="dropdown-item" href="./newBook.html" id="logoutBtn"><i class="fas fa-sign-out-alt"></i>
                                    Logout</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <div class="hero-section">
        <div class="container text-center">
            <h1 class="display-4 mb-3"><i class="fas fa-graduation-cap"></i> Student Book Marketplace</h1>
            <p class="lead">Buy and sell textbooks directly with fellow students. Save money, help others!</p>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container" id="books">
        <!-- Search and Filter -->
        <div class="search-box">
            <div class="input-group input-group-lg">
                <input type="text" class="form-control" id="searchInput"
                    placeholder="Search for books by title, author, or ISBN...">
                <button class="btn btn-primary" type="button" id="searchBtn">
                    <i class="fas fa-search"></i>
                </button>
            </div>
        </div>

        <div class="filter-section">
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">School</label>
                    <select class="form-select" id="filterCategory">
                        <option value="">All Categories</option>
                        <option value="Science">Science</option>
                        <option value="Mathematics">Mathematics</option>
                        <option value="Literature">Literature</option>
                        <option value="History">History</option>
                        <option value="Computer Science">Computer Science</option>
                        <option value="Business">Business</option>
                        <option value="Engineering">Engineering</option>
                        <option value="Management">Management</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Condition</label>
                    <select class="form-select" id="filterCondition">
                        <option value="">All Conditions</option>
                        <option value="New">New</option>
                        <option value="Excellent">Excellent</option>
                        <option value="Good">Good</option>
                        <option value="Fair">Fair</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Max Price</label>
                    <input type="number" class="form-control" id="filterPrice" placeholder="e.g., 100">
                </div>
                <div class="col-md-3">
                    <label class="form-label">&nbsp;</label>
                    <button class="btn btn-primary w-100" id="applyFilters">Apply Filters</button>
                </div>
            </div>
        </div>

        <!-- Books Grid -->
        <div id="marketplaceView">
            <div class="row" id="booksContainer">
                <!-- Books will be dynamically inserted here -->
            </div>

            <div id="noResults" class="text-center py-5" style="display: none;">
                <i class="fas fa-search fa-3x text-muted mb-3"></i>
                <h4 class="text-muted">No books found</h4>
                <p>Try adjusting your search or filters</p>
            </div>
        </div>

        <!-- Wishlist View -->
        <div id="wishlistView" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3><i class="fas fa-heart text-danger"></i> My Wishlist</h3>
                <button class="btn btn-secondary" id="backToMarketplace">
                    <i class="fas fa-arrow-left"></i> Back to Marketplace
                </button>
            </div>
            <div class="row" id="wishlistContainer">
                <!-- Wishlist books will be dynamically inserted here -->
            </div>
            <div id="wishlistEmpty" class="wishlist-empty" style="display: none;">
                <i class="fas fa-heart-broken"></i>
                <h4 class="text-muted">Your wishlist is empty</h4>
                <p>Start adding books you're interested in!</p>
                <button class="btn btn-primary" id="browseFromWishlist">
                    <i class="fas fa-book"></i> Browse Books
                </button>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div class="modal fade" id="loginModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-sign-in-alt"></i> Login to Your Account</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="loginForm">
                        <div class="mb-3">
                            <label class="form-label">Email Address</label>
                            <input type="email" class="form-control" id="loginEmail" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Password</label>
                            <input type="password" class="form-control" id="loginPassword" required>
                        </div>
                        <div class="alert alert-danger" id="loginError" style="display: none;"></div>
                    </form>
                    <p class="text-center mb-0">Don't have an account? <a href="#" data-bs-dismiss="modal"
                            data-bs-toggle="modal" data-bs-target="#registerModal">Register here</a></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="loginBtn">
                        <i class="fas fa-sign-in-alt"></i> Login
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Register Modal -->
    <div class="modal fade" id="registerModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-user-plus"></i> Create Your Account</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="registerForm">
                        <div class="mb-3">
                            <label class="form-label">Full Name</label>
                            <input type="text" class="form-control" id="registerName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Email Address</label>
                            <input type="email" class="form-control" id="registerEmail" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Password</label>
                            <input type="password" class="form-control" id="registerPassword" minlength="6" required>
                            <small class="form-text text-muted">Minimum 6 characters</small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Confirm Password</label>
                            <input type="password" class="form-control" id="registerConfirmPassword" required>
                        </div>
                        <div class="alert alert-danger" id="registerError" style="display: none;"></div>
                    </form>
                    <p class="text-center mb-0">Already have an account? <a href="#" data-bs-dismiss="modal"
                            data-bs-toggle="modal" data-bs-target="#loginModal">Login here</a></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="registerBtn">
                        <i class="fas fa-user-plus"></i> Register
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Sell Book Modal -->
    <div class="modal fade" id="sellBookModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-book"></i> List Your Book for Sale</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="sellBookForm">
                        <div class="row g-3">
                            <div class="col-12">
                                <label class="form-label">Book Image</label>
                                <div class="image-preview-container">
                                    <div class="image-preview" id="imagePreview">
                                        <div class="image-preview-placeholder">
                                            <i class="fas fa-image fa-3x mb-2"></i>
                                            <p>Click below to upload book image</p>
                                        </div>
                                    </div>
                                    <button type="button" class="btn btn-danger btn-sm remove-image-btn"
                                        id="removeImageBtn" style="display: none;">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                <input type="file" class="form-control mt-2" id="bookImage" accept="image/*">
                                <small class="form-text text-muted">Upload a clear image of your book (JPG, PNG, max
                                    5MB)</small>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Book Title *</label>
                                <input type="text" class="form-control" id="bookTitle" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Author *</label>
                                <input type="text" class="form-control" id="bookAuthor" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">ISBN</label>
                                <input type="text" class="form-control" id="bookISBN">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Category *</label>
                                <select class="form-select" id="bookCategory" required>
                                    <option value="">Select Category</option>
                                    <option value="Science">Science</option>
                                    <option value="Mathematics">Mathematics</option>
                                    <option value="Literature">Literature</option>
                                    <option value="History">History</option>
                                    <option value="Computer Science">Computer Science</option>
                                    <option value="Business">Business</option>
                                    <option value="Engineering">Engineering</option>
                                    <option value="Management">Management</option>
                                    <option value="Hospitality">Hospitality</option>
                                    <option value="Medical & Health">Medical & Health</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Condition *</label>
                                <select class="form-select" id="bookCondition" required>
                                    <option value="">Select Condition</option>
                                    <option value="New">New</option>
                                    <option value="Excellent">Excellent</option>
                                    <option value="Good">Good</option>
                                    <option value="Fair">Fair</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Price (R) *</label>
                                <input type="number" class="form-control" id="bookPrice" step="0.01" min="0" required>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Description</label>
                                <textarea class="form-control" id="bookDescription" rows="3"
                                    placeholder="Describe the book's condition, any highlights, notes, etc."></textarea>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="submitBook">
                        <i class="fas fa-check"></i> List Book
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Book Details Modal -->
    <div class="modal fade" id="bookDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="detailsTitle"></h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="detailsBody">
                    <!-- Details will be inserted here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Messages Modal -->
    <div class="modal fade" id="messagesModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-envelope"></i> Messages</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0">
                    <div class="row g-0">
                        <!-- Conversations List -->
                        <div class="col-md-4 border-end">
                            <div class="p-3 border-bottom">
                                <h6 class="mb-0">Conversations</h6>
                            </div>
                            <div class="conversation-list" id="conversationsList">
                                <div class="no-messages">
                                    <i class="fas fa-inbox fa-3x mb-2"></i>
                                    <p>No conversations yet</p>
                                </div>
                            </div>
                        </div>
                        <!-- Messages Area -->
                        <div class="col-md-8">
                            <div id="messageArea" style="display: none;">
                                <div class="p-3 border-bottom">
                                    <div class="d-flex align-items-center">
                                        <div class="conversation-avatar me-3" id="chatAvatar"></div>
                                        <div>
                                            <h6 class="mb-0" id="chatName"></h6>
                                            <small class="text-muted" id="chatBookTitle"></small>
                                        </div>
                                    </div>
                                </div>
                                <div class="messages-container" id="messagesContainer">
                                    <!-- Messages will appear here -->
                                </div>
                                <div class="p-3 border-top">
                                    <form id="messageForm">
                                        <div class="input-group">
                                            <input type="text" class="form-control" id="messageInput"
                                                placeholder="Type your message..." required>
                                            <button class="btn btn-primary" type="submit">
                                                <i class="fas fa-paper-plane"></i> Send
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                            <div id="noConversationSelected" class="no-messages"
                                style="height: 500px; display: flex; align-items: center; justify-content: center; flex-direction: column;">
                                <i class="fas fa-comments fa-3x mb-3"></i>
                                <p>Select a conversation to start messaging</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
    <script>
        // User management
        let users = [
            { id: 1, name: "Camagu Godana", email: "Camagu@university.edu", password: "password123" },
        ];
        let currentUser = null;
        let nextUserId = 2;

        // Messaging system
        let conversations = [];
        let messages = [];
        let nextMessageId = 1;
        let currentConversationId = null;

        // Wishlist system
        let wishlists = {};
        let isWishlistView = false;

        // In-memory storage for books
        let books = [
            {
                id: 1,
                title: "Introduction to Algorithms",
                author: "Cormen, Leiserson, Rivest",
                isbn: "978-0262033848",
                category: "Computer Science",
                condition: "Good",
                price: 195.00,
                description: "Classic algorithms textbook. Some highlighting in chapters 1-5.",
                sellerId: 1,
                seller: "Camagu Godana",
                email: "camagu@university.edu",
                datePosted: new Date(),
                image: null
            },
        ];

        let nextId = 2;
        let filteredBooks = [...books];
        let currentImageData = null;

        // Handle image upload and preview
        $('#bookImage').on('change', function (e) {
            const file = e.target.files[0];
            if (!file) return;

            if (file.size > 5 * 1024 * 1024) {
                showToast('Image size must be less than 5MB', 'error');
                $(this).val('');
                return;
            }

            if (!file.type.startsWith('image/')) {
                showToast('Please upload a valid image file', 'error');
                $(this).val('');
                return;
            }

            const reader = new FileReader();
            reader.onload = function (event) {
                currentImageData = event.target.result;
                $('#imagePreview').html(`<img src="${currentImageData}" alt="Book preview">`);
                $('#removeImageBtn').show();
            };
            reader.readAsDataURL(file);
        });

        $('#removeImageBtn').on('click', function () {
            currentImageData = null;
            $('#bookImage').val('');
            $('#imagePreview').html(`
                <div class="image-preview-placeholder">
                    <i class="fas fa-image fa-3x mb-2"></i>
                    <p>Click below to upload book image</p>
                </div>
            `);
            $(this).hide();
        });

        function updateUIForAuth() {
            if (currentUser) {
                $('#navLogin, #navRegister').hide();
                $('#navUserMenu, #navSellBook').show();
                $('#currentUserName').text(currentUser.name);
                updateUnreadCount();
                updateWishlistCount();
            } else {
                $('#navLogin, #navRegister').show();
                $('#navUserMenu, #navSellBook').hide();
            }
        }

        function updateWishlistCount() {
            if (!currentUser) return;
            const userWishlist = wishlists[currentUser.id] || [];
            const count = userWishlist.length;
            if (count > 0) {
                $('#wishlistCount').text(count).show();
            } else {
                $('#wishlistCount').hide();
            }
        }

        function isInWishlist(bookId) {
            if (!currentUser) return false;
            const userWishlist = wishlists[currentUser.id] || [];
            return userWishlist.includes(bookId);
        }

        function toggleWishlist(bookId) {
            if (!currentUser) {
                showToast('Please login to add to wishlist', 'error');
                return;
            }

            if (!wishlists[currentUser.id]) {
                wishlists[currentUser.id] = [];
            }

            const userWishlist = wishlists[currentUser.id];
            const index = userWishlist.indexOf(bookId);

            if (index > -1) {
                userWishlist.splice(index, 1);
                showToast('Removed from wishlist');
            } else {
                userWishlist.push(bookId);
                showToast('Added to wishlist! ❤️');
            }

            updateWishlistCount();

            if (isWishlistView) {
                displayWishlist();
            } else {
                displayBooks(filteredBooks);
            }
        }

        function displayWishlist() {
            if (!currentUser) {
                showToast('Please login to view wishlist', 'error');
                return;
            }

            isWishlistView = true;
            $('#marketplaceView').hide();
            $('#wishlistView').show();

            const userWishlist = wishlists[currentUser.id] || [];
            const wishlistBooks = books.filter(b => userWishlist.includes(b.id));

            const container = $('#wishlistContainer');
            container.empty();

            if (wishlistBooks.length === 0) {
                $('#wishlistEmpty').show();
                return;
            }

            $('#wishlistEmpty').hide();

            wishlistBooks.forEach(book => {
                const conditionClass = 'condition-' + book.condition.toLowerCase();
                const bookCard = `
                    <div class="col-md-4">
                        <div class="book-card">
                            <button class="favorite-btn favorited" data-book-id="${book.id}">
                                <i class="fas fa-heart"></i>
                            </button>
                            <div class="book-image">
                                ${book.image ?
                        `<img src="${book.image}" alt="${book.title}">` :
                        `<div class="default-icon"><i class="fas fa-book"></i></div>`
                    }
                            </div>
                            <div class="p-3">
                                <h5 class="mb-2">${book.title}</h5>
                                <p class="text-muted mb-2"><i class="fas fa-user"></i> ${book.author}</p>
                                <div class="mb-2">
                                    <span class="badge badge-condition ${conditionClass}">${book.condition}</span>
                                    <span class="badge bg-secondary">${book.category}</span>
                                </div>
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <span class="price-tag">R ${book.price.toFixed(2)}</span>
                                    <button class="btn btn-primary btn-sm view-details" data-id="${book.id}">
                                        View Details
                                    </button>
                                </div>
                                <div class="seller-info">
                                    <div class="seller-avatar">${book.seller.charAt(0)}</div>
                                    <small class="text-muted">Sold by ${book.seller}</small>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                container.append(bookCard);
            });
        }

        function backToMarketplace() {
            isWishlistView = false;
            $('#wishlistView').hide();
            $('#marketplaceView').show();
            displayBooks(books);
        }

        function updateUnreadCount() {
            if (!currentUser) return;

            let unreadCount = 0;
            conversations.forEach(conv => {
                if (conv.user1Id === currentUser.id || conv.user2Id === currentUser.id) {
                    const convMessages = messages.filter(m => m.conversationId === conv.id);
                    const unread = convMessages.filter(m =>
                        m.senderId !== currentUser.id && !m.read
                    ).length;
                    unreadCount += unread;
                }
            });

            if (unreadCount > 0) {
                $('#unreadCount').text(unreadCount).show();
            } else {
                $('#unreadCount').hide();
            }
        }

        function getOrCreateConversation(otherUserId, bookId) {
            let conversation = conversations.find(conv =>
                (conv.user1Id === currentUser.id && conv.user2Id === otherUserId && conv.bookId === bookId) ||
                (conv.user2Id === currentUser.id && conv.user1Id === otherUserId && conv.bookId === bookId)
            );

            if (!conversation) {
                const book = books.find(b => b.id === bookId);
                const otherUser = users.find(u => u.id === otherUserId);

                conversation = {
                    id: Date.now(),
                    user1Id: currentUser.id,
                    user2Id: otherUserId,
                    bookId: bookId,
                    bookTitle: book.title,
                    lastMessage: null,
                    lastMessageTime: new Date()
                };

                conversations.push(conversation);
            }

            return conversation;
        }

        function displayConversations() {
            if (!currentUser) return;

            const userConversations = conversations.filter(conv =>
                conv.user1Id === currentUser.id || conv.user2Id === currentUser.id
            );

            const container = $('#conversationsList');
            container.empty();

            if (userConversations.length === 0) {
                container.html(`
                    <div class="no-messages">
                        <i class="fas fa-inbox fa-3x mb-2"></i>
                        <p>No conversations yet</p>
                    </div>
                `);
                return;
            }

            userConversations.sort((a, b) => b.lastMessageTime - a.lastMessageTime);

            userConversations.forEach(conv => {
                const otherUserId = conv.user1Id === currentUser.id ? conv.user2Id : conv.user1Id;
                const otherUser = users.find(u => u.id === otherUserId);
                const convMessages = messages.filter(m => m.conversationId === conv.id);
                const unreadMessages = convMessages.filter(m =>
                    m.senderId !== currentUser.id && !m.read
                ).length;

                const activeClass = currentConversationId === conv.id ? 'active' : '';

                container.append(`
                    <div class="conversation-item ${activeClass}" data-conversation-id="${conv.id}">
                        <div class="d-flex">
                            <div class="conversation-avatar me-3">${otherUser.name.charAt(0)}</div>
                            <div class="flex-grow-1">
                                <div class="d-flex justify-content-between align-items-start">
                                    <h6 class="mb-0">${otherUser.name}</h6>
                                    ${unreadMessages > 0 ? `<span class="unread-indicator"></span>` : ''}
                                </div>
                                <small class="text-muted">${conv.bookTitle}</small>
                                ${conv.lastMessage ? `<p class="mb-0 text-muted small">${conv.lastMessage.substring(0, 30)}...</p>` : ''}
                            </div>
                        </div>
                    </div>
                `);
            });
        }

        function displayMessages(conversationId) {
            currentConversationId = conversationId;
            const conversation = conversations.find(c => c.id === conversationId);

            if (!conversation) return;

            const otherUserId = conversation.user1Id === currentUser.id ? conversation.user2Id : conversation.user1Id;
            const otherUser = users.find(u => u.id === otherUserId);
            const book = books.find(b => b.id === conversation.bookId);

            $('#chatAvatar').text(otherUser.name.charAt(0));
            $('#chatName').text(otherUser.name);
            $('#chatBookTitle').text(`About: ${book.title}`);

            const conversationMessages = messages.filter(m => m.conversationId === conversationId);

            const container = $('#messagesContainer');
            container.empty();

            if (conversationMessages.length === 0) {
                container.html(`
                    <div class="no-messages">
                        <i class="fas fa-comment-dots fa-2x mb-2"></i>
                        <p>No messages yet. Start the conversation!</p>
                    </div>
                `);
            } else {
                conversationMessages.forEach(msg => {
                    const isSent = msg.senderId === currentUser.id;
                    const messageClass = isSent ? 'message-sent' : 'message-received';
                    const time = new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                    container.append(`
                        <div class="d-flex ${isSent ? 'justify-content-end' : ''}">
                            <div class="message-bubble ${messageClass}">
                                <div>${msg.text}</div>
                                <div class="message-time">${time}</div>
                            </div>
                        </div>
                    `);

                    if (!isSent && !msg.read) {
                        msg.read = true;
                    }
                });

                container.scrollTop(container[0].scrollHeight);
            }

            $('#noConversationSelected').hide();
            $('#messageArea').show();
            displayConversations();
            updateUnreadCount();
        }

        $('#messageForm').on('submit', function (e) {
            e.preventDefault();

            const messageText = $('#messageInput').val().trim();
            if (!messageText || !currentConversationId) return;

            const newMessage = {
                id: nextMessageId++,
                conversationId: currentConversationId,
                senderId: currentUser.id,
                text: messageText,
                timestamp: new Date(),
                read: false
            };

            messages.push(newMessage);

            const conversation = conversations.find(c => c.id === currentConversationId);
            conversation.lastMessage = messageText;
            conversation.lastMessageTime = new Date();

            $('#messageInput').val('');
            displayMessages(currentConversationId);
            displayConversations();
        });

        $('#messagesBtn').on('click', function (e) {
            e.preventDefault();
            if (!currentUser) return;
            displayConversations();
            $('#messagesModal').modal('show');
        });

        $(document).on('click', '.conversation-item', function () {
            const conversationId = $(this).data('conversation-id');
            displayMessages(conversationId);
        });

        $(document).on('click', '#contactSellerBtn', function () {
            const sellerId = $(this).data('seller-id');
            const bookId = $(this).data('book-id');

            if (!currentUser) {
                showToast('Please login to message sellers', 'error');
                return;
            }

            const conversation = getOrCreateConversation(sellerId, bookId);
            bootstrap.Modal.getInstance($('#bookDetailsModal')).hide();
            displayConversations();
            $('#messagesModal').modal('show');

            setTimeout(() => {
                displayMessages(conversation.id);
            }, 300);
        });

        function showToast(message, type = 'success') {
            const bgClass = type === 'success' ? 'bg-success' : 'bg-danger';
            const icon = type === 'success' ? 'check-circle' : 'exclamation-circle';

            $('body').append(`
                <div class="position-fixed top-0 end-0 p-3" style="z-index: 11000">
                    <div class="toast show" role="alert">
                        <div class="toast-header ${bgClass} text-white">
                            <strong class="me-auto"><i class="fas fa-${icon}"></i> ${type === 'success' ? 'Success' : 'Error'}</strong>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
                        </div>
                        <div class="toast-body">${message}</div>
                    </div>
                </div>
            `);

            setTimeout(() => $('.toast').remove(), 3000);
        }

        $('#registerBtn').on('click', function () {
            const form = $('#registerForm');
            if (!form[0].checkValidity()) {
                form[0].reportValidity();
                return;
            }

            const name = $('#registerName').val();
            const email = $('#registerEmail').val();
            const password = $('#registerPassword').val();
            const confirmPassword = $('#registerConfirmPassword').val();

            if (password !== confirmPassword) {
                $('#registerError').text('Passwords do not match').show();
                return;
            }

            if (users.find(u => u.email === email)) {
                $('#registerError').text('Email already registered').show();
                return;
            }

            const newUser = {
                id: nextUserId++,
                name: name,
                email: email,
                password: password
            };

            users.push(newUser);
            currentUser = newUser;

            form[0].reset();
            $('#registerError').hide();
            bootstrap.Modal.getInstance($('#registerModal')).hide();

            updateUIForAuth();
            showToast('Registration successful! Welcome to Campus Books.');
        });

        $('#loginBtn').on('click', function () {
            const form = $('#loginForm');
            if (!form[0].checkValidity()) {
                form[0].reportValidity();
                return;
            }

            const email = $('#loginEmail').val();
            const password = $('#loginPassword').val();

            const user = users.find(u => u.email === email && u.password === password);

            if (!user) {
                $('#loginError').text('Invalid email or password').show();
                return;
            }

            currentUser = user;
            form[0].reset();
            $('#loginError').hide();
            bootstrap.Modal.getInstance($('#loginModal')).hide();

            updateUIForAuth();
            showToast('Login successful! Welcome back, ' + currentUser.name + '.');
        });

        $('#logoutBtn').on('click', function (e) {
            e.preventDefault();
            currentUser = null;
            backToMarketplace();
            updateUIForAuth();
            showToast('You have been logged out.');
        });

        $('#myListingsBtn').on('click', function (e) {
            e.preventDefault();
            if (!currentUser) return;

            backToMarketplace();
            const myBooks = books.filter(b => b.sellerId === currentUser.id);

            if (myBooks.length === 0) {
                showToast('You have no active listings.', 'info');
                displayBooks(books);
                return;
            }

            displayBooks(myBooks);
            $('html, body').animate({ scrollTop: $('#books').offset().top - 100 }, 500);
            showToast(`Showing your ${myBooks.length} listing(s)`, 'info');
        });

        $('#wishlistBtn').on('click', function (e) {
            e.preventDefault();
            if (!currentUser) {
                showToast('Please login to view wishlist', 'error');
                return;
            }
            displayWishlist();
            $('html, body').animate({ scrollTop: $('#books').offset().top - 100 }, 500);
        });

        $('#backToMarketplace, #browseFromWishlist').on('click', function (e) {
            e.preventDefault();
            backToMarketplace();
        });

        $(document).on('click', '.favorite-btn', function (e) {
            e.stopPropagation();
            const bookId = $(this).data('book-id');
            toggleWishlist(bookId);
        });

        $('#addListingBtn').on('click', function (e) {
            e.preventDefault();
            if (!currentUser) {
                showToast('Please login to add listings', 'error');
                return;
            }
            $('#sellBookModal').modal('show');
        });

        $('[data-bs-target="#sellBookModal"]').on('click', function () {
            if (!currentUser) {
                showToast('Please login to sell books', 'error');
                return false;
            }
        });

        function displayBooks(booksToDisplay) {
            const container = $('#booksContainer');
            const noResults = $('#noResults');

            container.empty();

            if (booksToDisplay.length === 0) {
                noResults.show();
                return;
            }

            noResults.hide();

            booksToDisplay.forEach(book => {
                const conditionClass = 'condition-' + book.condition.toLowerCase();
                const isFavorited = isInWishlist(book.id);
                const bookCard = `
                    <div class="col-md-4">
                        <div class="book-card">
                            ${currentUser ? `
                                <button class="favorite-btn ${isFavorited ? 'favorited' : ''}" data-book-id="${book.id}">
                                    <i class="fas fa-heart"></i>
                                </button>
                            ` : ''}
                            <div class="book-image">
                                ${book.image ?
                        `<img src="${book.image}" alt="${book.title}">` :
                        `<div class="default-icon"><i class="fas fa-book"></i></div>`
                    }
                            </div>
                            <div class="p-3">
                                <h5 class="mb-2">${book.title}</h5>
                                <p class="text-muted mb-2"><i class="fas fa-user"></i> ${book.author}</p>
                                <div class="mb-2">
                                    <span class="badge badge-condition ${conditionClass}">${book.condition}</span>
                                    <span class="badge bg-secondary">${book.category}</span>
                                </div>
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <span class="price-tag">R ${book.price.toFixed(2)}</span>
                                    <button class="btn btn-primary btn-sm view-details" data-id="${book.id}">
                                        View Details
                                    </button>
                                </div>
                                <div class="seller-info">
                                    <div class="seller-avatar">${book.seller.charAt(0)}</div>
                                    <small class="text-muted">Sold by ${book.seller}</small>
                                </div>
                                ${currentUser && book.sellerId === currentUser.id ? `
                                    <div class="mt-2">
                                        <button class="btn btn-danger btn-sm w-100 delete-book" data-id="${book.id}">
                                            <i class="fas fa-trash"></i> Delete Listing
                                        </button>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
                container.append(bookCard);
            });
        }

        function filterBooks() {
            const searchTerm = $('#searchInput').val().toLowerCase();
            const categoryFilter = $('#filterCategory').val();
            const conditionFilter = $('#filterCondition').val();
            const priceFilter = parseFloat($('#filterPrice').val()) || Infinity;

            filteredBooks = books.filter(book => {
                const matchesSearch = book.title.toLowerCase().includes(searchTerm) ||
                    book.author.toLowerCase().includes(searchTerm) ||
                    book.isbn.includes(searchTerm);
                const matchesCategory = !categoryFilter || book.category === categoryFilter;
                const matchesCondition = !conditionFilter || book.condition === conditionFilter;
                const matchesPrice = book.price <= priceFilter;

                return matchesSearch && matchesCategory && matchesCondition && matchesPrice;
            });

            displayBooks(filteredBooks);
        }

        $('#searchBtn, #searchInput').on('click keyup', function (e) {
            if (e.type === 'click' || e.keyCode === 13) {
                filterBooks();
            }
        });

        $('#applyFilters').on('click', filterBooks);

        $(document).on('click', '.view-details', function () {
            const bookId = $(this).data('id');
            const book = books.find(b => b.id === bookId);

            if (book) {
                $('#detailsTitle').text(book.title);
                $('#detailsBody').html(`
                    <div class="row">
                        ${book.image ? `
                            <div class="col-12 mb-3">
                                <img src="${book.image}" alt="${book.title}" class="img-fluid rounded" style="max-height: 400px; width: 100%; object-fit: contain; background: #f8f9fa;">
                            </div>
                        ` : ''}
                        <div class="col-md-6">
                            <h6><i class="fas fa-user"></i> Author</h6>
                            <p>${book.author}</p>
                            <h6><i class="fas fa-barcode"></i> ISBN</h6>
                            <p>${book.isbn || 'Not provided'}</p>
                            <h6><i class="fas fa-tag"></i> Category</h6>
                            <p>${book.category}</p>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="fas fa-star"></i> Condition</h6>
                            <p><span class="badge badge-condition condition-${book.condition.toLowerCase()}">${book.condition}</span></p>
                            <h6>Price</h6>
                            <p class="price-tag d-inline-block">R${book.price.toFixed(2)}</p>
                        </div>
                        <div class="col-12 mt-3">
                            <h6><i class="fas fa-info-circle"></i> Description</h6>
                            <p>${book.description || 'No description provided.'}</p>
                        </div>
                        <div class="col-12 mt-3">
                            <div class="alert alert-info">
                                <h6><i class="fas fa-user-circle"></i> Seller Information</h6>
                                <p class="mb-1"><strong>Name:</strong> ${book.seller}</p>
                                <p class="mb-0"><strong>Email:</strong> <a href="mailto:${book.email}">${book.email}</a></p>
                                ${currentUser && currentUser.id !== book.sellerId ? `
                                    <button class="btn btn-primary mt-2 w-100" id="contactSellerBtn" data-seller-id="${book.sellerId}" data-book-id="${book.id}">
                                        <i class="fas fa-comment"></i> Message Seller
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `);
                new bootstrap.Modal($('#bookDetailsModal')).show();
            }
        });

        $('#submitBook').on('click', function () {
            if (!currentUser) {
                showToast('Please login to sell books', 'error');
                return;
            }

            const form = $('#sellBookForm');
            if (!form[0].checkValidity()) {
                form[0].reportValidity();
                return;
            }

            const newBook = {
                id: nextId++,
                title: $('#bookTitle').val(),
                author: $('#bookAuthor').val(),
                isbn: $('#bookISBN').val(),
                category: $('#bookCategory').val(),
                condition: $('#bookCondition').val(),
                price: parseFloat($('#bookPrice').val()),
                description: $('#bookDescription').val(),
                sellerId: currentUser.id,
                seller: currentUser.name,
                email: currentUser.email,
                datePosted: new Date(),
                image: currentImageData
            };

            books.unshift(newBook);
            filterBooks();

            form[0].reset();
            currentImageData = null;
            $('#imagePreview').html(`
                <div class="image-preview-placeholder">
                    <i class="fas fa-image fa-3x mb-2"></i>
                    <p>Click below to upload book image</p>
                </div>
            `);
            $('#removeImageBtn').hide();
            bootstrap.Modal.getInstance($('#sellBookModal')).hide();

            showToast('Your book has been listed successfully!');
        });

        $(document).on('click', '.delete-book', function () {
            if (!confirm('Are you sure you want to delete this listing?')) {
                return;
            }

            const bookId = $(this).data('id');
            books = books.filter(b => b.id !== bookId);
            filterBooks();
            showToast('Listing deleted successfully');
        });

        updateUIForAuth();
        displayBooks(books);
    </script>
</body>

</html>